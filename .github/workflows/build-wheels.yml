name: Build Wheels

on:
  workflow_call:
    inputs:
      max_jobs:
        description: 'Parallel compilation jobs (reduce if OOM)'
        required: false
        default: '2'
        type: string
  workflow_dispatch:
    inputs:
      max_jobs:
        description: 'Parallel compilation jobs (reduce if OOM)'
        required: false
        default: '2'
        type: string

jobs:
  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: pip install build

      - name: Build sdist
        run: python -m build --sdist

      - uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  build_wheels:
    name: py${{ matrix.python }}-torch${{ matrix.torch }}-${{ matrix.cuda }}-${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-2022]
        python: ['3.10', '3.11', '3.12', '3.13']
        torch: ['2.5.1', '2.6.0', '2.7.1', '2.8.0', '2.9.0']
        cuda: ['cu118', 'cu121', 'cu124', 'cu126', 'cu128']
        exclude:
          # PyTorch 2.5.x: supports cu118, cu121, cu124
          - torch: '2.5.1'
            cuda: 'cu126'
          - torch: '2.5.1'
            cuda: 'cu128'

          # PyTorch 2.6.0: supports cu118, cu124, cu126 (dropped cu121)
          - torch: '2.6.0'
            cuda: 'cu121'
          - torch: '2.6.0'
            cuda: 'cu128'

          # PyTorch 2.7.x: supports cu118, cu126, cu128 (dropped cu121, cu124)
          - torch: '2.7.1'
            cuda: 'cu121'
          - torch: '2.7.1'
            cuda: 'cu124'

          # PyTorch 2.8.0: supports cu126, cu128 (dropped cu118)
          - torch: '2.8.0'
            cuda: 'cu118'
          - torch: '2.8.0'
            cuda: 'cu121'
          - torch: '2.8.0'
            cuda: 'cu124'

          # PyTorch 2.9.0: supports cu126, cu128 (cu130 available but skip for now)
          - torch: '2.9.0'
            cuda: 'cu118'
          - torch: '2.9.0'
            cuda: 'cu121'
          - torch: '2.9.0'
            cuda: 'cu124'

          # Python 3.12 compatibility
          - python: '3.12'
            torch: '2.5.1'
            cuda: 'cu118'  # Some py3.12 + old CUDA combinations may fail

          # Python 3.13 compatibility (only PyTorch 2.8.0+ supports Python 3.13)
          - python: '3.13'
            torch: '2.5.1'
          - python: '3.13'
            torch: '2.6.0'
          - python: '3.13'
            torch: '2.7.1'

          # PyTorch 2.9.0 Windows: has 'std': ambiguous symbol bug in compiled_autograd.h
          - os: 'windows-2022'
            torch: '2.9.0'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Free up disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          echo "Disk space after cleanup:"
          df -h

      - name: Install CUDA ${{ matrix.cuda }} (Linux)
        if: runner.os == 'Linux'
        run: |
          bash .github/workflows/cuda/Linux.sh ${{ matrix.cuda }}
        shell: bash

      - name: Install CUDA ${{ matrix.cuda }} (Windows)
        if: runner.os == 'Windows'
        run: |
          bash .github/workflows/cuda/Windows.sh ${{ matrix.cuda }}
        shell: bash

      - name: Install PyTorch ${{ matrix.torch }}+${{ matrix.cuda }}
        run: |
          pip install torch==${{ matrix.torch }} --index-url https://download.pytorch.org/whl/${{ matrix.cuda }}
          python -c "import torch; print('PyTorch:', torch.__version__)"
          python -c "import torch; print('CUDA:', torch.version.cuda)"
        shell: bash

      - name: Install build dependencies
        run: |
          pip install --upgrade pip setuptools wheel ninja
        shell: bash

      - name: Patch PyTorch static constexpr (Windows)
        if: runner.os == 'Windows'
        run: |
          Torch_DIR=$(python -c 'import os; import torch; print(os.path.dirname(torch.__file__))')
          sed -i '31,38c\
          TORCH_API void lazy_init_num_threads();' "${Torch_DIR}/include/ATen/Parallel.h"
        shell: bash

      - name: Set up Visual Studio (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Set version with build metadata
        run: |
          VERSION=$(python -c "exec(open('fussim/__init__.py').read()); print(__version__)")
          TORCH_TAG=$(echo "pt${{ matrix.torch }}" | sed 's/\.[0-9]*$//' | sed 's/\.//g')
          CUDA_TAG=${{ matrix.cuda }}
          NEW_VERSION="${VERSION}+${TORCH_TAG}${CUDA_TAG}"
          echo "Setting version to: ${NEW_VERSION}"
          sed -i "s/__version__ = \"${VERSION}\"/__version__ = \"${NEW_VERSION}\"/" fussim/__init__.py
          cat fussim/__init__.py | grep __version__
        shell: bash

      - name: Build wheel
        run: |
          source .github/workflows/cuda/${{ runner.os }}-env.sh ${{ matrix.cuda }}
          FUSSIM_CUDA_VARIANT=${{ matrix.cuda }} MAX_JOBS=${{ inputs.max_jobs || '2' }} python setup.py bdist_wheel --dist-dir=dist
        shell: bash
        env:
          DISTUTILS_USE_SDK: "1"

      - name: Fix Linux wheel platform tag
        if: runner.os == 'Linux'
        run: |
          cd dist
          for whl in *linux_x86_64.whl; do
            if [ -f "$whl" ]; then
              newname="${whl/linux_x86_64/manylinux_2_28_x86_64}"
              echo "Renaming $whl -> $newname"
              mv "$whl" "$newname"
            fi
          done
          ls -la
        shell: bash

      - name: Test wheel installation
        run: |
          pip install dist/*.whl
          python -c "import fussim; print('fussim version:', fussim.__version__)"
        shell: bash

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-py${{ matrix.python }}-torch${{ matrix.torch }}-${{ matrix.cuda }}-${{ matrix.os }}
          path: dist/*.whl

  # =============================================================================
  # Build CUDA variant extensions for fat wheel
  # Each job builds one CUDA variant's .so/.pyd file
  # =============================================================================
  build_cuda_variant:
    name: cuda-${{ matrix.cuda }}-py${{ matrix.python }}-${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-2022]
        python: ['3.10', '3.11', '3.12', '3.13']
        cuda: ['cu118', 'cu124', 'cu126', 'cu128']
        exclude:
          # Python 3.13 + CUDA 11.8: old toolchains don't support Python 3.13
          - python: '3.13'
            cuda: 'cu118'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Free up disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          echo "Disk space after cleanup:"
          df -h

      - name: Install CUDA ${{ matrix.cuda }} (Linux)
        if: runner.os == 'Linux'
        run: |
          bash .github/workflows/cuda/Linux.sh ${{ matrix.cuda }}
        shell: bash

      - name: Install CUDA ${{ matrix.cuda }} (Windows)
        if: runner.os == 'Windows'
        run: |
          bash .github/workflows/cuda/Windows.sh ${{ matrix.cuda }}
        shell: bash

      # Install PyTorch version that matches CUDA
      - name: Install PyTorch for CUDA ${{ matrix.cuda }}
        run: |
          # Pick PyTorch version based on CUDA
          case "${{ matrix.cuda }}" in
            cu118) TORCH_VER="2.5.1" ;;
            cu124) TORCH_VER="2.6.0" ;;
            cu126) TORCH_VER="2.8.0" ;;
            cu128) TORCH_VER="2.8.0" ;;
          esac
          pip install torch==${TORCH_VER} --index-url https://download.pytorch.org/whl/${{ matrix.cuda }}
          python -c "import torch; print('PyTorch:', torch.__version__)"
          python -c "import torch; print('CUDA:', torch.version.cuda)"
        shell: bash

      - name: Install build dependencies
        run: |
          pip install --upgrade pip setuptools wheel ninja
        shell: bash

      - name: Patch PyTorch static constexpr (Windows)
        if: runner.os == 'Windows'
        run: |
          Torch_DIR=$(python -c 'import os; import torch; print(os.path.dirname(torch.__file__))')
          sed -i '31,38c\
          TORCH_API void lazy_init_num_threads();' "${Torch_DIR}/include/ATen/Parallel.h"
        shell: bash

      - name: Set up Visual Studio (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build CUDA variant extension
        run: |
          source .github/workflows/cuda/${{ runner.os }}-env.sh ${{ matrix.cuda }}
          FUSSIM_CUDA_VARIANT=${{ matrix.cuda }} MAX_JOBS=${{ inputs.max_jobs || '2' }} python setup.py build_ext --inplace
          # Find and copy the built extension
          mkdir -p cuda_ext
          if [ "${{ runner.os }}" == "Windows" ]; then
            find build -name "_cuda_${{ matrix.cuda }}*.pyd" -exec cp {} cuda_ext/ \;
          else
            find build -name "_cuda_${{ matrix.cuda }}*.so" -exec cp {} cuda_ext/ \;
          fi
          ls -la cuda_ext/
        shell: bash
        env:
          DISTUTILS_USE_SDK: "1"

      - name: Upload CUDA variant extension
        uses: actions/upload-artifact@v4
        with:
          name: cuda-ext-${{ matrix.cuda }}-py${{ matrix.python }}-${{ matrix.os }}
          path: cuda_ext/*

  # =============================================================================
  # Merge all CUDA variants into fat wheel for PyPI
  # =============================================================================
  build_pypi_wheels:
    name: pypi-py${{ matrix.python }}-${{ matrix.os }}
    needs: [build_cuda_variant]
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-2022]
        python: ['3.10', '3.11', '3.12', '3.13']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install build dependencies
        run: |
          pip install --upgrade pip setuptools wheel
        shell: bash

      # Download all CUDA variant extensions for this Python version/OS
      - name: Download CUDA extensions
        uses: actions/download-artifact@v4
        with:
          pattern: cuda-ext-*-py${{ matrix.python }}-${{ matrix.os }}
          path: cuda_extensions
          merge-multiple: true

      - name: List downloaded extensions
        run: |
          echo "Downloaded CUDA extensions:"
          find cuda_extensions -type f
        shell: bash

      - name: Build fat wheel with all CUDA variants
        run: |
          pip install wheel

          # Create wheel structure manually
          mkdir -p wheel_build/fussim

          # Copy Python source files
          cp fussim/__init__.py wheel_build/fussim/
          cp fussim/py.typed wheel_build/fussim/ 2>/dev/null || touch wheel_build/fussim/py.typed

          # Copy all CUDA extensions
          cp cuda_extensions/* wheel_build/fussim/

          echo "Package contents:"
          ls -la wheel_build/fussim/

          # Get version and create dist-info
          VERSION=$(python -c "exec(open('fussim/__init__.py').read()); print(__version__)")
          PYTHON_TAG="cp${{ matrix.python == '3.10' && '310' || matrix.python == '3.11' && '311' || matrix.python == '3.12' && '312' || '313' }}"

          if [ "${{ runner.os }}" == "Windows" ]; then
            PLATFORM_TAG="win_amd64"
          else
            PLATFORM_TAG="manylinux_2_28_x86_64"
          fi

          WHEEL_NAME="fussim-${VERSION}-${PYTHON_TAG}-${PYTHON_TAG}-${PLATFORM_TAG}.whl"

          mkdir -p "wheel_build/fussim-${VERSION}.dist-info"

          # Create METADATA
          cat > "wheel_build/fussim-${VERSION}.dist-info/METADATA" << EOF
          Metadata-Version: 2.1
          Name: fussim
          Version: ${VERSION}
          Summary: Optimized CUDA implementation of differentiable SSIM for PyTorch
          Home-page: https://github.com/OpsiClear/fussim
          License: MIT
          Requires-Python: >=3.10
          Requires-Dist: torch>=2.5
          EOF

          # Create WHEEL
          cat > "wheel_build/fussim-${VERSION}.dist-info/WHEEL" << EOF
          Wheel-Version: 1.0
          Generator: custom
          Root-Is-Purelib: false
          Tag: ${PYTHON_TAG}-${PYTHON_TAG}-${PLATFORM_TAG}
          EOF

          # Create top_level.txt
          echo "fussim" > "wheel_build/fussim-${VERSION}.dist-info/top_level.txt"

          # Create entry_points.txt
          cat > "wheel_build/fussim-${VERSION}.dist-info/entry_points.txt" << EOF
          [console_scripts]
          fussim-check = fussim:_cli_check
          EOF

          # Create RECORD (will be updated by wheel)
          touch "wheel_build/fussim-${VERSION}.dist-info/RECORD"

          # Create wheel
          mkdir -p dist
          cd wheel_build
          python -c "
          import hashlib
          import base64
          import os
          import zipfile

          def hash_file(path):
              h = hashlib.sha256()
              with open(path, 'rb') as f:
                  h.update(f.read())
              digest = base64.urlsafe_b64encode(h.digest()).rstrip(b'=').decode('ascii')
              size = os.path.getsize(path)
              return f'sha256={digest}', size

          wheel_name = '${WHEEL_NAME}'
          dist_info = 'fussim-${VERSION}.dist-info'

          records = []
          with zipfile.ZipFile(f'../dist/{wheel_name}', 'w', zipfile.ZIP_DEFLATED) as whl:
              for root, dirs, files in os.walk('.'):
                  for f in files:
                      path = os.path.join(root, f)
                      arcname = path[2:]  # Remove ./
                      if arcname == f'{dist_info}/RECORD':
                          continue
                      whl.write(path, arcname)
                      hash_val, size = hash_file(path)
                      records.append(f'{arcname},{hash_val},{size}')

              # Add RECORD
              records.append(f'{dist_info}/RECORD,,')
              record_content = '\n'.join(records)
              whl.writestr(f'{dist_info}/RECORD', record_content)

          print(f'Created {wheel_name}')
          "
          cd ..

          echo "Built wheel:"
          ls -la dist/
        shell: bash

      - name: Fix Linux wheel platform tag
        if: runner.os == 'Linux'
        run: |
          cd dist
          for whl in *linux_x86_64.whl; do
            if [ -f "$whl" ]; then
              newname="${whl/linux_x86_64/manylinux_2_28_x86_64}"
              echo "Renaming $whl -> $newname"
              mv "$whl" "$newname"
            fi
          done
          ls -la
        shell: bash

      - name: Install and test fat wheel
        run: |
          # Install PyTorch for testing (use latest that supports any CUDA)
          pip install torch==2.8.0 --index-url https://download.pytorch.org/whl/cu128
          pip install dist/*.whl
          python -c "import fussim; print('fussim version:', fussim.__version__)"
          # Test that extension loading works
          python -c "from fussim import fused_ssim; print('Extension loaded successfully')"
        shell: bash

      - name: Upload PyPI wheel
        uses: actions/upload-artifact@v4
        with:
          name: pypi-wheel-py${{ matrix.python }}-${{ matrix.os }}
          path: dist/*.whl
